<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/lp-sdk.js - laposte-sdk</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/img/logo.png" title="laposte-sdk" width="261" height="60"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Digiposte.html">Digiposte</a></li>
                                <li><a href="../classes/HttpError.html">HttpError</a></li>
                                <li><a href="../classes/LaPoste.html">LaPoste</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/laPosteSdk.html">laPosteSdk</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: lib/lp-sdk.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var util = require(&#x27;util&#x27;)
  , _ = require(&#x27;lodash&#x27;)
  , Promise = require(&#x27;bluebird&#x27;)
  , urljoin = require(&#x27;url-join&#x27;)
  , request = require(&#x27;request&#x27;)
  , laPosteSdk;

/**
 * @class HttpError
 * @extends Error
 * @constructor
 * @param {Integer} statusCode Status code of the HTTP response.
 * @param {String} [body] Body of the HTTP response.
 */
function HttpError(statusCode, body) {
  this.name = &#x27;HttpError&#x27;;
  this.message = util.format(&#x27;Http error %s%s&#x27;, statusCode, body ? util.format(&#x27; [ %s ]&#x27;, typeof body === &#x27;string&#x27; ? body : JSON.stringify(body)) : &#x27;&#x27;);
  this.statusCode = statusCode;
  this.body = body;
}
HttpError.prototype = Error.prototype;

/**
 * @private
 * @method httpErrorHandler
 */
function httpErrorHandler(res, body) {
  if (res.statusCode &lt; 200 || res.statusCode &gt;= 300) {
    throw new HttpError(res.statusCode, body);
  }
  return body;
}

/**
 * @private
 * @method buildAsyncRequest
 */
function buildAsyncRequest(config) {
  var asyncRequest = Promise.promisify(request.defaults(config.request));
  return function (opt) {
    opt.uri = urljoin(config.baseUrl, opt.uri);
    return asyncRequest(opt);
  };
}

/**
 * This class provides general service about La Poste Open API.
 *
 * @class LaPoste
 * @constructor
 * @param {Object} [options] Options object.
 * @param {String} [options.config] Custom configuration.
 * @param {String} [options.config.baseUrl=https://api.laposte.fr/digiposte/1.0] Base URL of API resources.
 * @param {String} [options.config.request] Default configuration for request module.
 */
function LaPoste(config) {
  var that = this;
  that.config = {
    baseUrl: process.env[&#x27;LAPOSTE_API_BASE_URL&#x27;] || &#x27;https://api.laposte.fr/&#x27;,
    request: {
      strictSSL: process.env[&#x27;LAPOSTE_API_STRICT_SSL&#x27;] ? process.env[&#x27;LAPOSTE_API_STRICT_SSL&#x27;] !== &#x27;false&#x27; : true
    }
  };
  _.extend(that.config, config);
  this.apiRequest = buildAsyncRequest(that.config);
}

/**
 * Authenticate a developer, and provide a token for La Poste Open API.
 *
 * The resulting token is stored as &quot;accessToken&quot; instance attribute.
 *
 * @method auth
 * @async
 * @param {Object} options Options object.
 * @param {String} options.consumerKey The consumer key.
 * @param {String} options.consumerSecret The consumer secret.
 * @param {String} options.username The developer account username.
 * @param {String} options.password The developer account password.
 * @param {Function} [cb] The callback(err, result) function to be called when the request is fulfilled, if not defined a promise is returned.
 * @optional
 * @return {Promise} A promise, fulfilled when the request is done.
 * @throws {HttpError} An HTTP error including status code and body.
 * @example
 *
 *      var lpSdk = require(&#x27;lp-sdk&#x27;)
 *        , lp = new lpSdk.LaPoste();
 *
 *      lp.auth({
 *        consumerKey: &#x27;zzzz-aaa-ccc&#x27;,
 *        consumerSecret: &#x27;aaaa-ccc-rrr&#x27;,
 *        username: &#x27;john&#x27;,
 *        password: &#x27;mysecret&#x27;
 *      }, function (err, result) {
 *        if (err) {
 *          console.error(err);
 *          return;
 *        }
 *        console.log(&#x27;result :&#x27;, result);
 *      });
 *
 */
LaPoste.prototype.auth = function (opt, cb) {
  var that = this;
  if (typeof cb === &#x27;undefined&#x27; &amp;&amp; typeof opt === &#x27;function&#x27;) {
    cb = opt;
    opt = null;
  }
  opt = opt || {};
  return that.apiRequest(
    {
      method: &#x27;POST&#x27;,
      uri: &#x27;/oauth2/token&#x27;,
      json: true,
      form: {
        &#x27;client_id&#x27;: opt.consumerKey || process.env[&#x27;LAPOSTE_API_CONSUMER_KEY&#x27;],
        &#x27;client_secret&#x27;: opt.consumerSecret || process.env[&#x27;LAPOSTE_API_CONSUMER_SECRET&#x27;],
        &#x27;grant_type&#x27;: &#x27;password&#x27;,
        username: opt.username || process.env[&#x27;LAPOSTE_API_USERNAME&#x27;],
        password: opt.password || process.env[&#x27;LAPOSTE_API_PASSWORD&#x27;]
      }
    })
    .spread(httpErrorHandler)
    .then(function (result) {
      that.accessToken = result[&#x27;access_token&#x27;];
      that.refreshToken = result[&#x27;refresh_token&#x27;];
      return result;
    })
    .nodeify(cb);
};

/**
 * This class provides services of the Digiposte API.
 *
 * @class Digiposte
 * @constructor
 * @param {Object} [options] Options object.
 * @param {String} [options.accessToken] The La Poste access token.
 * @param {String} [options.dgpAccessToken] The Digiposte access token.
 * @param {String} [options.config] Custom configuration.
 * @param {String} [options.config.baseUrl=https://api.laposte.fr/digiposte/1.0] Base URL of API resources.
 * @param {String} [options.config.request] Default configuration for request module.
 */
function Digiposte(opt) {
  var that = this;
  opt = opt || {};
  that.config = {
    baseUrl: process.env[&#x27;DIGIPOSTE_API_BASE_URL&#x27;] || &#x27;https://api.laposte.fr/digiposte/1.0&#x27;,
    request: {
      strictSSL: process.env[&#x27;DIGIPOSTE_API_STRICT_SSL&#x27;] ? process.env[&#x27;LAPOSTE_API_STRICT_SSL&#x27;] !== &#x27;false&#x27; : true
    }
  };
  _.extend(that, opt);
  this.apiRequest = buildAsyncRequest(that.config);
}

/**
 * Authenticate a Digiposte customer, and provide a token for Digiposte API services.
 *
 * The resulting token is stored as &quot;dgpAccessToken&quot; instance attribute.
 *
 * @method auth
 * @async
 * @param {Object} options Options object.
 * @param {String} options.username The Digiposte account username.
 * @param {String} options.password The Digiposte account password.
 * @param {Function} [cb] The callback(err, result) function to be called when the request is fulfilled, if not defined a promise is returned.
 * @optional
 * @return {Promise} A promise, fulfilled when the request is done.
 * @throws {HttpError} An HTTP error including status code and body.
 * @example
 *      var lpSdk = require(&#x27;lp-sdk&#x27;)
 *        , dgp = new lpSdk.Digiposte();
 *
 *      dgp.auth({
 *        user: &#x27;tom&#x27;,
 *        password: &#x27;mypassword&#x27;
 *      }, function (err, result) {
 *        if (err) {
 *          console.error(err);
 *          return;
 *        }
 *        console.log(&#x27;result :&#x27;, result);
 *      });
 */
Digiposte.prototype.auth = function (opt, cb) {
  var that = this;
  if (typeof cb === &#x27;undefined&#x27; &amp;&amp; typeof opt === &#x27;function&#x27;) {
    cb = opt;
    opt = null;
  }
  opt = opt || {};
  return that.apiRequest(
    {
      method: &#x27;POST&#x27;,
      uri: &#x27;/login&#x27;,
      headers: {
        &#x27;Authorization&#x27;: util.format(&#x27;Bearer %s&#x27;, opt.accessToken || process.env[&#x27;LAPOSTE_API_ACCESS_TOKEN&#x27;])
      },
      json: true,
      body: {
        credential: {
          user: opt.username || process.env[&#x27;DIGIPOSTE_API_USERNAME&#x27;],
          password: opt.password || process.env[&#x27;DIGIPOSTE_API_PASSWORD&#x27;]
        }
      }
    })
    .spread(httpErrorHandler)
    .then(function (result) {
      that.accessToken = opt.accessToken || process.env[&#x27;LAPOSTE_API_ACCESS_TOKEN&#x27;];
      that.dgpAccessToken = result[&#x27;access_token&#x27;];
      that.dgpRefreshToken = result[&#x27;refresh_token&#x27;];
      return result;
    })
    .nodeify(cb);
};

/**
 * Get documents of the safebox.
 *
 * @method getDocs
 * @async
 * @param {Object} options Options object.
 * @param {Integer} options.index The index of the pagination.
 * @param {Integer} options.maxResults The maximum number of results returned.
 * @param {String} options.sort The field on which you want to sort the results.
 * @param {String} options.direction The direction in which you want to sort the results, for the given field.
 * @param {Function} [cb] The callback(err, result) function to be called when the request is fulfilled, if not defined a promise is returned.
 * @optional
 * @return {Promise} A promise, fulfilled when the request is done.
 * @throws {HttpError} An HTTP error including status code and body.
 * @example
 *      var lpSdk = require(&#x27;lp-sdk&#x27;)
 *        , dgp = new lpSdk.Digiposte({
 *          accessToken: &#x27;zzz-eee-aaa-vvv&#x27;,
 *          dgpAccessToken: &#x27;kkk-ccc-vvv-rrr&#x27;
 *        });
 *
 *      // Get all docs
 *      dgp.getDocs(function (err, result) {
 *        if (err) {
 *          console.error(err);
 *          return;
 *        }
 *        console.log(&#x27;result :&#x27;, result);
 *      });
 *
 *      // Get first doc
 *      dgp.getDocs({
 *        index: 1,
 *        maxResults: 1
 *      }, function (err, result) {
 *        if (err) {
 *          console.error(err);
 *          return;
 *        }
 *        console.log(&#x27;result :&#x27;, result);
 *      });
 *
 *      // Get docs of the trash location
 *      dgp.getDocs({location: &#x27;trash&#x27;}, function (err, result) {
 *        if (err) {
 *          console.error(err);
 *          return;
 *        }
 *        console.log(&#x27;result :&#x27;, result);
 *      });
 */
Digiposte.prototype.getDocs = function (opt, cb) {
  var that = this
    , params = {};
  if (typeof cb === &#x27;undefined&#x27; &amp;&amp; typeof opt === &#x27;function&#x27;) {
    cb = opt;
    opt = null;
  }
  opt = opt || {};
  if (typeof opt.index !== &#x27;undefined&#x27;) {
    params.index = opt.index;
  }
  if (typeof opt.maxResults !== &#x27;undefined&#x27;) {
    params[&#x27;max_results&#x27;] = opt.maxResults;
  }
  if (typeof opt.sort !== &#x27;undefined&#x27;) {
    params.sort = opt.sort;
  }
  if (typeof opt.direction !== &#x27;undefined&#x27;) {
    params.direction = opt.direction;
  }
  return that.apiRequest(
    {
      uri: util.format(&#x27;/documents%s&#x27;, opt.location ? &#x27;/&#x27; + opt.location : &#x27;&#x27;),
      headers: {
        &#x27;Authorization&#x27;: util.format(&#x27;Bearer %s&#x27;, that.accessToken),
        &#x27;User-Token&#x27;: that.dgpAccessToken
      },
      json: true,
      qs: params
    })
    .spread(httpErrorHandler)
    .nodeify(cb);
};

/**
 * Get document by id.
 *
 * @method getDoc
 * @async
 * @param {Object} options Options object.
 * @param {Integer} options.id The document id.
 * @param {Function} [cb] The callback(err, result) function to be called when the request is fulfilled, if not defined a promise is returned.
 * @optional
 * @return {Promise} A promise, fulfilled when the request is done.
 * @throws {HttpError} An HTTP error including status code and body.
 * @example
 * @TODO
 */
Digiposte.prototype.getDoc = function (opt, cb) {
  var that = this;
  return that.apiRequest(
    {
      uri: util.format(&#x27;/document/%s&#x27;, opt.id),
      headers: {
        &#x27;Authorization&#x27;: util.format(&#x27;Bearer %s&#x27;, that.accessToken),
        &#x27;User-Token&#x27;: that.dgpAccessToken
      },
      json: true
    })
    .spread(httpErrorHandler)
    .nodeify(cb);
};

/**
 * Get document thumbnail.
 *
 * The result is a Buffer populated with binary data of downloaded thumbnail.
 *
 * @method getDocThumbnail
 * @async
 * @param {Object} options Options object.
 * @param {Integer} options.id The document id.
 * @param {Function} [cb] The callback(err, result) function to be called when the request is fulfilled, if not defined a promise is returned.
 * @optional
 * @return {Promise} A promise, fulfilled when the request is done.
 * @throws {HttpError} An HTTP error including status code and body.
 * @example
 * @TODO
 */
Digiposte.prototype.getDocThumbnail = function (opt, cb) {
  var that = this;
  return that.apiRequest(
    {
      uri: util.format(&#x27;/document/%s/thumbnail&#x27;, opt.id),
      headers: {
        &#x27;Authorization&#x27;: util.format(&#x27;Bearer %s&#x27;, that.accessToken),
        &#x27;User-Token&#x27;: that.dgpAccessToken
      },
      encoding: null
    })
    .spread(httpErrorHandler)
    .nodeify(cb);
};

/**
 * Provides the base class of the La Poste Open API SDK.
 *
 * @module laPosteSdk
 */
laPosteSdk = {
  LaPoste: LaPoste,
  Digiposte: Digiposte,
  HttpError: HttpError
};

exports = module.exports = laPosteSdk;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
